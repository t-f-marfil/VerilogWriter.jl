<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Mid-Level Synthesis · VerilogWriter Document</title><meta name="title" content="Mid-Level Synthesis · VerilogWriter Document"/><meta property="og:title" content="Mid-Level Synthesis · VerilogWriter Document"/><meta property="twitter:title" content="Mid-Level Synthesis · VerilogWriter Document"/><meta name="description" content="Documentation for VerilogWriter Document."/><meta property="og:description" content="Documentation for VerilogWriter Document."/><meta property="twitter:description" content="Documentation for VerilogWriter Document."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">VerilogWriter Document</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><span class="tocitem">User Guide</span><ul><li><a class="tocitem" href="../">Introduction</a></li><li><a class="tocitem" href="../qstart/">Quick Start</a></li><li><a class="tocitem" href="../types/">Basic Types</a></li><li><a class="tocitem" href="../inference/">Basic Automation</a></li><li><a class="tocitem" href="../fsm/">Finite State Machines</a></li><li class="is-active"><a class="tocitem" href>Mid-Level Synthesis</a><ul class="internal"><li><a class="tocitem" href="#Midmodule"><span>Midmodule</span></a></li><li><a class="tocitem" href="#Mmodgraph"><span>Mmodgraph</span></a></li><li><a class="tocitem" href="#Connect-Ports-between-Verilog-Modules"><span>Connect Ports between Verilog Modules</span></a></li><li><a class="tocitem" href="#Generate-Vmodule-Objects"><span>Generate Vmodule Objects</span></a></li></ul></li><li><a class="tocitem" href="../reference/">Reference</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">User Guide</a></li><li class="is-active"><a href>Mid-Level Synthesis</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Mid-Level Synthesis</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/t-f-marfil/VerilogWriter.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/t-f-marfil/VerilogWriter.jl/blob/develop/docs/src/midlevel.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Mid-Level-Synthesis"><a class="docs-heading-anchor" href="#Mid-Level-Synthesis">Mid-Level Synthesis</a><a id="Mid-Level-Synthesis-1"></a><a class="docs-heading-anchor-permalink" href="#Mid-Level-Synthesis" title="Permalink"></a></h1><p>We offer here a tool to help creating a connection between multiple verilog modules.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Methods described in this section is not fully debugged yet. Verilog codes generated using funtionalities in this page may contain unexpected behavior, and thus having precise inspection on output codes is desirable.</p></div></div><h2 id="Midmodule"><a class="docs-heading-anchor" href="#Midmodule">Midmodule</a><a id="Midmodule-1"></a><a class="docs-heading-anchor-permalink" href="#Midmodule" title="Permalink"></a></h2><p>Here we wrap a <code>Vmodule</code> object with <code>Midmodule</code> objects. </p><pre><code class="language-julia-repl hljs">julia&gt; a = Randmmod(&quot;a&quot;);

julia&gt; println(typeof(a));
Midmodule

julia&gt; @Randmmod b; # declare Midmodule named &quot;b&quot; as variable `b`</code></pre><p><code>Midmodule</code> objects can be handled in a similar manner to that of <code>Vmodule</code>. You may add, for example, ports and always-blocks, using <code>vpush!</code>.</p><pre><code class="language-julia-repl hljs">julia&gt; vpush!(a, @always (
       counter &lt;= counter + $(Wireexpr(8, 1))
       ));

julia&gt; vshow(a.vmod);
module a ();
    always_ff @( unknownedge  ) begin
        counter &lt;= (counter + 8&#39;d1);
    end
endmodule
type: Vmodule</code></pre><h2 id="Mmodgraph"><a class="docs-heading-anchor" href="#Mmodgraph">Mmodgraph</a><a id="Mmodgraph-1"></a><a class="docs-heading-anchor-permalink" href="#Mmodgraph" title="Permalink"></a></h2><p>We handle connections in between <code>Midmodule</code>s using <code>Mmodgraph</code> objects.</p><pre><code class="language-julia-repl hljs">julia&gt; g = Mmodgraph();</code></pre><p><code>Mmodgraph</code> is a callable object, and you may register connections between <code>Midmodule</code>s to this object.</p><pre><code class="language-julia-repl hljs">julia&gt; g(a =&gt; b);</code></pre><p>We also offer a method to convert <code>Mmodgraph</code> into a graph written in DOT language, and the connections can be visualized this way.</p><pre><code class="language-julia-repl hljs">julia&gt; dotgen(g; dpi=196) |&gt; println;
digraph{
rankdir = LR;
dpi = 196;

a [shape=oval];
b [shape=oval];
a -&gt; b;
}</code></pre><p>Using, for example, Graphviz, the graph below would be generated.</p><p><img src="../pic/g_ab.png" alt/></p><h2 id="Connect-Ports-between-Verilog-Modules"><a class="docs-heading-anchor" href="#Connect-Ports-between-Verilog-Modules">Connect Ports between Verilog Modules</a><a id="Connect-Ports-between-Verilog-Modules-1"></a><a class="docs-heading-anchor-permalink" href="#Connect-Ports-between-Verilog-Modules" title="Permalink"></a></h2><p>The connection in the example above connected Midmodule <code>a</code> and <code>b</code>. However, there is no data transaction available between the modules. You may explicitly register ports to be connected between <code>Midmodule</code>s. Here we construct new connection from Midmodule <code>a</code> to <code>c</code> with an eight-bits wide data line.</p><pre><code class="language-julia-repl hljs">julia&gt; @Randmmod c;

julia&gt; g(a =&gt; c, [(@oneport @out 8 dout) =&gt; (@oneport @in 8 din)]);</code></pre><p>We declare the connection between <code>a</code> and <code>c</code> using <code>Oneport</code>. Note that at this time the Midmodules do not contain ports declared here. You also need to add the ports to each Midmodule object.</p><pre><code class="language-julia-repl hljs">julia&gt; vpush!(a, @ports @out @logic 8 dout);

julia&gt; vpush!(c, @ports @in 8 din);</code></pre><h3 id="Automatically-Generated-Connections"><a class="docs-heading-anchor" href="#Automatically-Generated-Connections">Automatically-Generated Connections</a><a id="Automatically-Generated-Connections-1"></a><a class="docs-heading-anchor-permalink" href="#Automatically-Generated-Connections" title="Permalink"></a></h3><p>When adding connection to <code>Mmodgraph</code>s, VerilogWriter.jl automatically adds to both upstream and downstream module two ports, which are <code>valid</code> and <code>update</code> lines.</p><p>These ports can be used to control timing when a transaction between <code>Midmodule</code>s occurs.</p><p><img src="../pic/imsigtype.png" alt/></p><p><code>valid</code> is the signal driven by upstream module, and when asserted the data lines connected between the modules should contain valid data.</p><p><code>update</code> is the signal driven by downstream module, and asserting the signal tells upstream modules that the data lines can be updated with new data.</p><p>This may be similar to the First-Word-Fall-Through model in that downstream modules may process data before returning any signal (such as an acknowledgement signal).</p><p>As is often the case with handshaking signals, <code>valid</code> signals <strong>must not</strong> wait for the <code>update</code> signals. <code>valid</code> should be asserted independently from <code>update</code> (at least from <code>update</code> value at the same clock cycle) in order to avoid creating combinational loop in verilog codes.</p><p>Note that VerilogWriter.jl only adds the ports to <code>Midmodule</code>s, and thus you need to add to each <code>Midmodule</code> object logics that properly handle the <code>valid</code> and <code>update</code> signals. This also means that you may completely ignore the <code>update</code> and <code>valid</code> signals even when using <code>Mmodgraph</code> (you may need to connect the signals to <code>0</code> or <code>1</code> to suppress warnings from compilers, though).</p><p>To get the name of <code>valid</code> and <code>update</code> ports, you may call <code>nametolower</code> (for downstream facing ports) or <code>nametoupper</code> (for upstream facing ports) method with enum value <code>imupdate</code> or <code>imvalid</code>.</p><pre><code class="language-julia-repl hljs">julia&gt; alb = @always (
       $(nametoupper(imupdate)) &lt;= 1; # always update
       if $(nametoupper(imupdate)) &amp; $(nametoupper(imvalid))
           recv_count &lt;= recv_count + $(Wireexpr(8, 1))
       end
       );

julia&gt; vpush!(b, alb);</code></pre><h3 id="Synchronizing-Transactions"><a class="docs-heading-anchor" href="#Synchronizing-Transactions">Synchronizing Transactions</a><a id="Synchronizing-Transactions-1"></a><a class="docs-heading-anchor-permalink" href="#Synchronizing-Transactions" title="Permalink"></a></h3><p><code>g::Mmodgraph</code> in the above example currently generates the graph below.</p><p><img src="../pic/g_abc.png" alt/></p><p>When connecting more than one downstream <code>Midmodule</code> to one upstream <code>Midmodule</code>, VerilogWriter.jl automatically adds synchronizing logic to <code>Mmodgraph</code>. <code>valid</code> and <code>update</code> signals are modified automatically and a transaction between <code>a</code> and <code>b/c</code> does not complete unless both <code>b</code> and <code>c</code> assert <code>update</code> signal to <code>a</code>. From upstream module&#39;s (<code>a</code>&#39;s) perspective, <code>b</code> and <code>c</code> look like a single module which has one <code>update</code> and one <code>valid</code> port.</p><pre><code class="language-julia-repl hljs">julia&gt; ala = @always (
       $(nametolower(imvalid)) &lt;= 1;
       if $(nametolower(imvalid)) &amp; $(nametolower(imupdate))
           send_count &lt;= send_count + $(Wireexpr(7, 1))
       end
       ); # the same `valid` and `update` wire is connected to both `b` and `c`

julia&gt; vpush!(a, ala); vshow(a.vmod);
module a (
    output logic [7:0] dout
);
    always_ff @( unknownedge  ) begin
        counter &lt;= (counter + 8&#39;d1);
    end
    always_ff @( unknownedge  ) begin
        valid_to_lower_port0 &lt;= 1;
        if ((valid_to_lower_port0 &amp; update_from_lower_port0)) begin
            send_count &lt;= (send_count + 7&#39;d1);
        end
    end
endmodule
type: Vmodule</code></pre><p>The same applies to cases where a single downstream <code>Midmodule</code> is connected to multiple upstream <code>Midmodule</code>s. Note that ports other than <code>valid</code> and <code>update</code> in downstream <code>Midmodule</code> cannot be connected to multiple upstream ports, which is the same as connecting ports in raw verilog module instances. For now no warning and error is returned from VerilogWriter.jl even in such erroneous cases, and it can be detected, for instance, applying linter on generated verilog outputs.</p><pre><code class="language-julia-repl hljs">julia&gt; @Randmmod d;

julia&gt; g(d =&gt; c, [(@oneport @out 32 douttoC) =&gt; (@oneport @in 32 dinfromD)]
       ); # must not connect to `din` in `c`, which is already connected to `a`

julia&gt; vpush!(c, @oneport @in 32 dinfromD); vpush!(d, @oneport @out 32 douttoC);

julia&gt; vpush!(c, @always (
       $(nametoupper(imupdate)) = 1
       )); # connected to `update` of both `a` and `d`</code></pre><h3 id="Suppress-Synchronization-in-Connecting-Midmodules"><a class="docs-heading-anchor" href="#Suppress-Synchronization-in-Connecting-Midmodules">Suppress Synchronization in Connecting <code>Midmodule</code>s</a><a id="Suppress-Synchronization-in-Connecting-Midmodules-1"></a><a class="docs-heading-anchor-permalink" href="#Suppress-Synchronization-in-Connecting-Midmodules" title="Permalink"></a></h3><p>There are cases where multiple connection from one <code>Mmodule</code> should be completely independent from one another. In such cases you may wrap connection in <code>Midport</code> to separate connections to multiple groups.</p><pre><code class="language-julia-repl hljs">julia&gt; @Randmmod e;

julia&gt; @assert 1 != defaultMidPid; # currently defaultMidPid == 0

julia&gt; vpush!(e, @oneport @in 8 dinfroma);

julia&gt; g(Midport(1, a) =&gt; Midport(defaultMidPid, e), 
       [(@oneport @out 8 dout) =&gt; (@oneport @in 8 dinfroma)]
       ); # connect `a` at Midport id 1 to `e`</code></pre><p>Currently <code>g</code> generates the graph below:</p><p><img src="../pic/g_abcde.png" alt/></p><p>Connections between <code>Midport</code>s is not synchronized if they have different <code>Midport</code> id (a member<code>::Int</code> of <code>Midport</code>). In the example above, <code>a::Midmodule</code> is connected to three <code>Midmodule</code>s, which are <code>b</code>, <code>c</code> and <code>e</code>. Connection between <code>a</code> and <code>e</code> is assigned Midport id <code>1</code>, while connection between others are assigned <code>defaultMidPid</code> (this port id is assigned to the connection which is registered to <code>Mmodgraph</code> without explicitly specifying port id). Therefore, transaction between <code>a</code> and <code>b/c</code> is synchronized through <code>valid</code> and <code>update</code> independently from transactions between <code>a</code> and <code>e</code>. As a consequence <code>a</code> needs to include additional logic to handle <code>valid</code> and <code>update</code> signal for Midport whose id is other than <code>defaultMidPid</code>.</p><pre><code class="language-julia-repl hljs">julia&gt; vpush!(a, @always (
       if $(nametolower(imvalid, 1)) &amp; $(nametolower(imupdate, 1))
           $(nametolower(imvalid, 1)) &lt;= 0;
       else
           $(nametolower(imvalid, 1)) &lt;= 1
       end
       )); # valid and update associated with Midport(1, a)</code></pre><h2 id="Generate-Vmodule-Objects"><a class="docs-heading-anchor" href="#Generate-Vmodule-Objects">Generate Vmodule Objects</a><a id="Generate-Vmodule-Objects-1"></a><a class="docs-heading-anchor-permalink" href="#Generate-Vmodule-Objects" title="Permalink"></a></h2><p>After adding logics to each <code>Midmodule</code>, you may generate a list of <code>Vmodule</code>s exported from <code>Mmodgraph</code>.</p><pre><code class="language-julia-repl hljs">julia&gt; vmods = layer2vmod!(g);

julia&gt; println(typeof(vmods));
Vector{Vmodule}</code></pre><p>At the head of the exported list of <code>Vmodule</code>s is the top level <code>Vmodule</code> which represents the whole <code>Mmodgraph</code>, and the rest are the modules which are instanciated inside the top module. You may call <code>vfinalize.(vmods)</code> to further conduct wire width inferences and wire declarations.</p><h3 id="Port-Lifting"><a class="docs-heading-anchor" href="#Port-Lifting">Port Lifting</a><a id="Port-Lifting-1"></a><a class="docs-heading-anchor-permalink" href="#Port-Lifting" title="Permalink"></a></h3><p>Each <code>Midmodule</code> objects can have (verilog) ports that are not connected to other <code>Midmodule</code>s. These ports are automatically added to the top level <code>Vmodule</code> when calling <code>layer2vmod!</code> and is accessible from outer verilog modules.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../fsm/">« Finite State Machines</a><a class="docs-footer-nextpage" href="../reference/">Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Tuesday 2 January 2024 05:50">Tuesday 2 January 2024</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
